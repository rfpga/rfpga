# Verifying USRP1 Functionality on UHD 4.0

This guide walks you through verifying that an Ettus USRP1 device functions correctly on a system using UHD 4.0.0+, even though official support was removed after UHD 3.15.x.

---

## Prerequisites

- **USRP1 hardware** with RFX daughterboards installed (e.g., RFX900 on both TX and RX paths)
- **UHD 4.0.0+ installed from source** (with USRP1 support not fully removed)
- **GNU Radio (3.8 or later)**

---

## 1. Verify UHD Version

Run the following to check your UHD version:

```bash
uhd_config_info --version
```

Expected output:

```
UHD 4.0.0.0-XXX-gXXXXXXXX
```

Sample verified output:

```
UHD 4.0.0.0-240-gb38c9d83
```

---

## 2. Probe USRP1 Device

Run:

```bash
sudo uhd_usrp_probe
```

Look for output confirming:

- FX2 firmware is loaded
- FPGA image is loaded
- Daughterboards are detected correctly:
  - RFX900 on Slot A (both TX and RX paths)
- Clock rate shows `64.000000 MHz`

✅ Verified Output Example (UHD 4.0.0.0-240):

```
[INFO] [FX2] Firmware loaded
[INFO] [FX2] FPGA image loaded
...
RX Dboard: A - RFX900 (0x0025)
TX Dboard: A - RFX900 (0x0029)
```

This confirms that **RFX900s are installed on both TX and RX sides in Slot A** under UHD 4.0 in this build.

---

## 3. Spectrum Scan (Receive Test)\$1

✅ **Confirmation Examples:** Below are screenshots confirming successful receive tests:

**1. TX-to-RX Loopback with spike at 915 MHz:**



This sharp spike at 915 MHz confirms TX→RX signal detection via loopback using two RFX900s on USRP1.

**2. Baseline Noise Floor at 915 MHz (Idle):**



This shows the typical RX noise floor when there is no signal transmitted — verifying functional spectrum scan readiness.

---

## 4. Loopback Test (TX to RX) — Same Frequency Band Only

> ⚠️ **Important**: You must use two RFX900s or loop TX/RX through the same RFX900 for frequency compatibility.

### Valid Setup with Two RFX900s on Slot A:

You can connect the TX and RX ports safely through coax + attenuator or antennas.

```bash
# Terminal A (TX)
uhd_siggen --args="type=usrp1,tx_subdev_spec=A:0" --freq=915e6 --gain=10 --samp-rate=8e6 --sine
```

```bash
# Terminal B (RX)
uhd_fft --args="type=usrp1,rx_subdev_spec=A:0" --freq=915e6 --gain=30 --samp-rate=1e6
```

> ❗ USRP1 only supports **one process at a time** — do not run two UHD-based apps (like `uhd_siggen` and `uhd_fft`) concurrently. You must run them sequentially or use a combined TX/RX flowgraph in GNU Radio.

---

## 4.1. Two-Laptop TX/RX Test Setup (Best Practice)

If you have **two USRP1 devices**, each with an **RFX900**, and **two laptops**, you can perform a true over-the-air or wired RF transmission test.

### Setup:

- **Laptop A** → USRP1 with RFX900 (TX)
- **Laptop B** → USRP1 with RFX900 (RX)
- Antennas or coax + attenuator between the two

### Laptop A (TX):

```bash
uhd_siggen --args="type=usrp1" --freq=915e6 --gain=10 --samp-rate=8e6 --sine
```

### Laptop B (RX):

```bash
uhd_fft --args="type=usrp1" --freq=915e6 --gain=30 --samp-rate=1e6
```

### Benefits:

- ✅ No resource contention (each UHD app has its own hardware)
- ✅ Real-time transmission and reception
- ✅ Safe and scalable for further development or OpenBTS

---

## 5. GRC Flowgraph Test

### Example Python Code Generated from GRC

Below is a simplified version of the `grc_test.py` script generated by GNU Radio Companion when using USRP1:

```python
from gnuradio import gr, qtgui, uhd
from PyQt5 import Qt
import sip, sys, signal, time

class grc_test(gr.top_block, Qt.QWidget):
    def __init__(self):
        gr.top_block.__init__(self, "USRP1 Test")
        Qt.QWidget.__init__(self)
        self.setWindowTitle("USRP1 Test")
        self.samp_rate = 500e3

        self.uhd_usrp_source_0 = uhd.usrp_source(
            "type=usrp1",
            uhd.stream_args(cpu_format="fc32", channels=[0]),
        )
        self.uhd_usrp_source_0.set_center_freq(915e6, 0)
        self.uhd_usrp_source_0.set_gain(30, 0)
        self.uhd_usrp_source_0.set_antenna('TX/RX', 0)
        self.uhd_usrp_source_0.set_samp_rate(self.samp_rate)

        self.qtgui_freq_sink_x_0 = qtgui.freq_sink_c(
            1024, qtgui.WIN_BLACKMAN_hARRIS, 915e6, self.samp_rate, "", 1
        )
        self.qtgui_freq_sink_x_0.set_update_time(0.10)
        self.qtgui_freq_sink_x_0.set_y_axis(-140, -60)
        self._qtgui_freq_sink_x_0_win = sip.wrapinstance(
            self.qtgui_freq_sink_x_0.pyqwidget(), Qt.QWidget
        )

        self.connect((self.uhd_usrp_source_0, 0), (self.qtgui_freq_sink_x_0, 0))

    def closeEvent(self, event):
        event.accept()

def main():
    qapp = Qt.QApplication(sys.argv)
    tb = grc_test()
    tb.start()
    tb.show()

    def sig_handler(sig=None, frame=None):
        Qt.QApplication.quit()

    signal.signal(signal.SIGINT, sig_handler)
    signal.signal(signal.SIGTERM, sig_handler)

    qapp.aboutToQuit.connect(lambda: (tb.stop(), tb.wait()))
    qapp.exec_()

if __name__ == '__main__':
    main()
```

This script configures a basic flowgraph to visualize spectrum data from a USRP1 device centered at 915 MHz using a 500 kHz sampling rate.

> ⚠️ **Warning:** USRP1 does not support PPS-based timing. If your GRC script includes:
>
> ```python
> self.uhd_usrp_source_0.set_time_unknown_pps(uhd.time_spec())
> ```
>
> You will encounter:
>
> ```
> ```

RuntimeError: LookupError: Path not found in tree: /mboards/0/time/pps

> ```
>
> ✅ **Fix:** Remove that line from the generated Python code or modify GRC to avoid using PPS timing mode. Set Sync to `None` or leave default.
> ```

You can visually verify USRP1 reception using GNU Radio Companion (GRC):

![GRC USRP Source Configuration]\(Screenshot 2025-07-12 at 21.19.17.png)

![QT GUI Frequency Sink Configuration]\(Screenshot 2025-07-12 at 21.24.12.png)

### Steps:\$1

3.1. In **QT GUI Frequency Sink**, set these parameters:

- **FFT Size**: `1024`
- **Update Rate**: `0.10`
- **Center Frequency**: match USRP Source (e.g., `915e6`)
- **Y Range**: `-140` to `-60`
- **Average Alpha**: `0.1` (adjust smoothing)

3.2. In **USRP Source**, sample rate should match bandwidth in sink:

- **Sample Rate**: `500e3` (typical stable value for USRP1)

3.3. ✅ **Run** ▶️ and observe the spectrum around 915 MHz.

✅ You should see either a baseline noise floor or active signals depending on nearby RF conditions or transmissions from your TX setup.

If you see continuous `OOOOOO` in terminal output, it means your machine can't keep up (overruns). Fix it by:

- Reducing sample rate (e.g., `250e3`)
- Closing background apps
- Running with `sudo nice -n -10`
- Or increasing buffer size with: `self.uhd_usrp_source_0.set_min_output_buffer(8192)`

---

## 6. (Optional) OpenBTS Integration

For OpenBTS:

- Use a 52 MHz FPGA image (e.g., `usrp1_fpga_52mhz.rbf`)
- Replace `/usr/local/share/uhd/images/usrp1_fpga.rbf` with the 52 MHz version
- Launch `uhd_usrp_probe` to verify 52 MHz clock
- Modify OpenBTS transceiver config accordingly

---

## Notes

- USRP1 is **officially unsupported** in UHD 4.x but may still work in early 4.0.x builds
- RFX900s installed in Slot A can support both TX and RX if properly connected
- Only **one UHD app at a time** can access a USRP1 device
- Full compatibility for OpenBTS or GSM stack may require UHD 3.15.x

---

## Conclusion

If all the above steps succeed, your USRP1 is functional under UHD 4.0.0, at least for RX/TX. Proceed with caution and consider UHD 3.15.x for long-term support or OpenBTS integration.

